fid = fopen('periodic_subcell.xyz','w');
fid2 = fopen('periodic_subcell.coord','w');
fid3 = fopen('Dlead1_subcell.coord','w');
fid4 = fopen('lead2_subcell.coord','w');
fid5 = fopen('lattice_subcell.coord','w');
fid6 = fopen('main_subcell.xyz','w');

C=1;H=2;N=3;F=4;S=5;Au=6;
num1=1;num2=1;
num=45+2*3+2*16*10;
fprintf(fid,'%d\n',num1*num2*(num));
fprintf(fid,'monohydride\n');

a = 4.22/sqrt(2);
mx=[a 0 0];
my = a.*[0.5 sqrt(3)/2 0];
x=4.*mx;
y=2.*(2.*my-mx);
ax=norm(x);
ay=norm(y);
c=a*sqrt(2)/sqrt(3);
a0=0.529177249;
z = [0 0 95]
fprintf(fid6,'CRYSTAL\nPRIMVEC\n');
fprintf(fid6,'%.16f %.16f %.16f \n%.16f %.16f %.16f \n%.16f %.16f %.16f \n',x,y,z);
fprintf(fid6,'CONVVEC\n');
fprintf(fid6,'%.16f %.16f %.16f \n%.16f %.16f %.16f \n%.16f %.16f %.16f \n',x,y,z);
fprintf(fid6,'PRIMCOORD\n');
fprintf(fid6,'%d  1\n',num-2*3*16);


juncf005=[S       3.291202   13.223363   14.857637
C       2.567617   12.063289   15.981194
C       1.748687   11.168056   15.289574
C       1.684106   11.401554   13.880201
C       2.453032   12.502268   13.486838
C       2.844805   12.131185   17.448689
C       4.055547   11.579787   17.968239
C       4.314995   11.647706   19.369379
C       3.327908   12.199906   20.237526
C       2.104665   12.725151   19.725754
C       1.879968   12.727512   18.317146
C       5.064307   10.914287   17.053048
C       5.633528   11.132060   19.909898
C       3.572029   12.229590   21.718903
C       3.723344   13.445870   22.432421
C       3.919989   13.484108   23.825611
C       3.975694   12.295454   24.598420
C       3.826102   11.071286   23.895915
C       3.637805   11.046682   22.499324
F       3.679781   14.628234   21.764246
F       4.066953   14.676214   24.463863
N       4.090197   12.340494   25.992849
F       3.874200    9.909601   24.603831
F       3.505776    9.837936   21.892603
C       1.039337   13.276151   20.652544
C       0.617200   13.361097   17.767584
N       2.634544   13.000888   12.182175
H       1.196701   10.361198   15.806324
H       1.078929   10.807607   13.170447
H       5.983983   11.536767   16.933523
H       5.393614    9.932162   17.464023
H       4.642872   10.740893   16.040302
H       5.825443   11.499056   20.940862
H       5.650641   10.015859   19.943136
H       6.485967   11.452493   19.269070
H       1.044972   14.392989   20.658562
H       0.021106   12.956132   20.336288
H       1.189970   12.938395   21.700052
H       0.452777   14.372646   18.205735
H       0.658815   13.462137   16.662622
H      -0.287378   12.754963   18.016712
H       4.412743   11.464786   26.424695
H       4.603884   13.153061   26.356237
H       2.563644   14.023655   12.106775
H       1.987571   12.574651   11.501527
Au      4.702886   12.845908   10.625203
Au      7.497388   12.516188   10.635645
Au      7.629585    9.673565   10.598013
Au      0.448343   10.241071   27.468321
Au     -0.900463   12.785656   27.466543
Au      1.961281   12.686892   27.463982
Au      1.644107   11.129774    8.435360
Au      5.012052   14.536753   29.624387
Au      3.082561   13.749461    8.446206
Au      3.591548   11.922607   29.678088
Au      4.591960   11.067154    8.398045
Au      2.050209   14.599561   29.593883
Au      6.150187   13.831689    8.400884
Au      0.529266   11.944865   29.851300
Au      7.674373   11.116896    8.175279
Au     -1.020245   14.620227   29.624642
Au      9.163202   13.747928    8.565972
Au     -2.557059   11.931392   29.618466
Au     10.646026   11.135811    8.414794
Au     -3.983773   14.536123   29.631634
Au     12.092796   13.719299    8.448398
Au     -5.455028   11.942549   29.620187
Au      1.636638   16.313541    8.452291
Au      5.018007    9.340899   29.612853
Au      3.110315   18.864000    8.449576
Au      3.547942    6.769340   29.621552
Au      4.591622   16.321913    8.429964
Au      2.077913    9.285838   29.593321
Au      6.091175   18.830665    8.482589
Au      0.523503    6.780097   29.609418
Au      7.662327   16.335873    8.458126
Au     -1.064379    9.278422   29.643937
Au      9.189156   18.842979    8.507411
Au     -2.529511    6.773015   29.621040
Au     10.641728   16.294136    8.434819
Au     -4.000663    9.345710   29.624901
Au     12.114539   18.884762    8.435749
Au     -5.457442    6.768218   29.625236
Au      1.659238    9.416238    5.904189
Au      4.994674   16.247040   32.168895
Au      3.144924   12.006104    5.912478
Au      3.498772   13.665753   32.152726
Au      4.650715    9.412447    5.944467
Au      2.012770   16.241951   32.124255
Au      6.115957   12.014195    5.900868
Au      0.518724   13.686133   32.163181
Au      7.629086    9.390321    5.878284
Au     -0.976927   16.247297   32.127518
Au      9.143825   12.027335    5.874648
Au     -2.462195   13.662303   32.146294
Au     10.601400    9.409724    5.929582
Au     -3.960863   16.245032   32.169473
Au     12.111573   12.004809    5.909980
Au     -5.451591   13.663488   32.154728
Au      1.665064   14.582664    5.928381
Au      5.000060   11.076241   32.149546
Au      3.145130   17.171477    5.894207
Au      3.492834    8.493739   32.135098
Au      4.646653   14.588864    5.929019
Au      2.023073   11.063551   32.171348
Au      6.134021   17.170987    5.938357
Au      0.519512    8.491383   32.141022
Au      7.628570   14.586835    5.947595
Au     -0.987926   11.070057   32.157259
Au      9.123582   17.173446    5.931399
Au     -2.463707    8.491834   32.148552
Au     10.598918   14.586075    5.943329
Au     -3.955648   11.082147   32.132766
Au     12.108638   17.166233    5.896117
Au     -5.452623    8.491297   32.169280
Au      1.660115    7.689677    3.456055
Au      4.988366   17.976673   34.601057
Au      3.156763   10.273852    3.470637
Au      3.497786   15.387988   34.601815
Au      4.648797    7.696994    3.471788
Au      2.009013   17.965755   34.592643
Au      6.132287   10.280153    3.462675
Au      0.518155   15.387496   34.595024
Au      7.627788    7.687637    3.466159
Au     -0.972063   17.964776   34.595834
Au      9.124401   10.274870    3.456738
Au     -2.462303   15.386324   34.601121
Au     10.609718    7.687889    3.467529
Au     -3.953362   17.976270   34.602791
Au     12.100836   10.273386    3.470457
Au     -5.450003   15.388184   34.605353
Au      1.661689   12.857910    3.462458
Au      4.993835   12.804068   34.602396
Au      3.156846   15.437546    3.469532
Au      3.501268   10.217275   34.597846
Au      4.646042   12.862137    3.469797
Au      2.009978   12.802390   34.605272
Au      6.137103   15.450812    3.472906
Au      0.515793   10.213637   34.604836
Au      7.624444   12.867324    3.460891
Au     -0.974282   12.801927   34.603006
Au      9.116588   15.442832    3.482277
Au     -2.464910   10.221038   34.593527
Au     10.615032   12.865564    3.463791
Au     -3.957061   12.803336   34.597804
Au     12.104545   15.435950    3.475048
Au     -5.447477   10.225891   34.594813
Au      1.660169    5.960115    1.031004
Au      4.994292   19.700617   37.036113
Au      3.153418    8.546761    1.031004
Au      3.502291   17.116176   37.036113
Au      4.643833    5.964310    1.031004
Au      2.009912   19.697384   37.036113
Au      6.136610    8.547137    1.031004
Au      0.518085   17.114320   37.036113
Au      7.629903    5.962748    1.031004
Au     -0.974981   19.697524   37.036113
Au      9.120769    8.545946    1.031004
Au     -2.466652   17.115411   37.036113
Au     10.612573    5.961267    1.031004
Au     -3.957680   19.700918   37.036113
Au     12.103473    8.546658    1.031004
Au     -5.449922   17.116949   37.036113
Au      1.660738   11.129478    1.031004
Au      4.994123   14.531886   37.036113
Au      3.154302   13.714918    1.031004
Au      3.501935   11.945807   37.036113
Au      4.643273   11.131875    1.031004
Au      2.009610   14.531687   37.036113
Au      6.136203   13.717669    1.031004
Au      0.517511   11.946422   37.036113
Au      7.628702   11.131714    1.031004
Au     -0.974185   14.531313   37.036113
Au      9.120056   13.717928    1.031004
Au     -2.466283   11.945652   37.036113
Au     10.614153   11.131734    1.031004
Au     -3.958138   14.531047   37.036113
Au     12.103759   13.715715    1.031004
Au     -5.449495   11.946144   37.036113
Au      1.660135    4.233439   -1.405414
Au      4.994286   21.428764   39.472522
Au      3.152128    6.817902   -1.405414
Au      3.502302   18.844700   39.472522
Au      4.644337    4.233683   -1.405414
Au      2.010128   21.428787   39.472522
Au      6.136381    6.817748   -1.405414
Au      0.518246   18.844543   39.472522
Au      7.628128    4.233723   -1.405414
Au     -0.973498   21.428725   39.472522
Au      9.120196    6.817973   -1.405414
Au     -2.465701   18.844667   39.472522
Au     10.612377    4.233593   -1.405414
Au     -3.957755   21.428662   39.472522
Au     12.104345    6.817941   -1.405414
Au     -5.449702   18.844629   39.472522
Au      1.660214    9.401261   -1.405414
Au      4.994330   16.260918   39.472522
Au      3.152137   11.985818   -1.405414
Au      3.502484   13.676511   39.472522
Au      4.644208    9.401310   -1.405414
Au      2.010366   16.261098   39.472522
Au      6.136349   11.985657   -1.405414
Au      0.518221   13.676821   39.472522
Au      7.628160    9.401443   -1.405414
Au     -0.973796   16.261003   39.472522
Au      9.120403   11.985762   -1.405414
Au     -2.465922   13.676459   39.472522
Au     10.612454    9.401357   -1.405414
Au     -3.957844   16.260877   39.472522
Au     12.104328   11.985734   -1.405414
Au     -5.449756   13.676483   39.472522
Au      1.660405    2.517261   -3.841832
Au      4.994163   23.145303   41.908939
Au      3.152157    5.101611   -3.841832
Au      3.502313   20.561055   41.908939
Au      4.644206    2.517453   -3.841832
Au      2.010174   23.145109   41.908939
Au      6.136378    5.101702   -3.841832
Au      0.518172   20.560870   41.908939
Au      7.628493    2.517537   -3.841832
Au     -0.973875   23.145112   41.908939
Au      9.120457    5.101569   -3.841832
Au     -2.465935   20.561082   41.908939
Au     10.612479    2.517286   -3.841832
Au     -3.957825   23.145262   41.908939
Au     12.104386    5.101606   -3.841832
Au     -5.449863   20.561106   41.908939
Au      1.660354    7.685166   -3.841832
Au      4.994176   17.977251   41.908939
Au      3.152349   10.269413   -3.841832
Au      3.502191   15.392974   41.908939
Au      4.644306    7.685363   -3.841832
Au      2.010305   17.977130   41.908939
Au      6.136287   10.269644   -3.841832
Au      0.518192   15.392823   41.908939
Au      7.628455    7.685459   -3.841832
Au     -0.973965   17.977127   41.908939
Au      9.120421   10.269545   -3.841832
Au     -2.465859   15.392934   41.908939
Au     10.612268    7.685315   -3.841832
Au     -3.957847   17.977221   41.908939
Au     12.104419   10.269354   -3.841832
Au     -5.449833   15.393017   41.908939];
juncpos=juncf005(:,2:4);
[N,M]=size(juncpos);
%I=find(juncpos(:,3)==4.872836); %A
%J=find(juncpos(:,3)==0.000000); %C
K=find(juncpos(:,3)==-1.405414); %B
lead1=zeros(16*3,3);
shift=[0 -2*a*sqrt(3)/6 -c];
for i=1:16;
   lead1((i-1)*3+1,:)=juncpos(K(i),:); %B
   lead1((i-1)*3+2,:)=juncpos(K(i),:)+shift;
   lead1((i-1)*3+3,:)=juncpos(K(i),:)+2.*shift;
end
%I=find(juncpos(:,3)==31.845030); %A
%J=find(juncpos(:,3)==36.717866); %C
K=find(juncpos(:,3)==39.472522); %B
lead2=zeros(16*3,3);
for i=1:16;
   lead2((i-1)*3+1,:)=juncpos(K(i),:); %B
   lead2((i-1)*3+2,:)=juncpos(K(i),:)-shift;
   lead2((i-1)*3+3,:)=juncpos(K(i),:)-2*shift;
end
condr = juncpos(1:(N-4*16),:);
minC = min(condr,[],1);
minL1 = min(lead1,[],1);
minL2 = min(lead2,[],1);

temp=min(minC,minL1)
mindim=min(temp,minL2);

shiftx=[-mindim(1) 0 0]
shifty=[0 -mindim(2) 0]
shiftz=[0 0 -mindim(3)]
shift=shiftx+shifty+shiftz;

%perform shifts
%now all z's are non-negative
%shift z's so that lead1 is lattice constant from origin of box for lead
shift2=[0 0 3*c];

for i=1:(N-4*16)
   condr(i,:)=condr(i,:)+shift+shift2;
end
for i=1:16*3
   lead1(i,:)=lead1(i,:)+shift+shift2;
   lead2(i,:)=lead2(i,:)+shift+shift2;
end



%SCALE about min(condr(:,3)) - lead calculation used 160 instead of 150 grid spacings!!!
dz2=6*c/160;
htcondr = max(condr(:,3))-min(condr(:,3));
q2=htcondr/dz2;
nq2=round(q2);
newhtcondr=nq2*dz2;
scale=newhtcondr/htcondr

max0=max(condr(:,3));
min0=min(condr(:,3));
%only shift lead2. don't scale.
for i=1:(N-4*16)
   condr(i,3)=min0+scale*(condr(i,3)-min0);
end
for i=1:16*3
   lead2(i,3)=lead2(i,3)-max0+newhtcondr+2*3*c;
end

% add periodic units
per1=zeros(3*16,3);
per2=zeros(3*16,3);

for i=1:16*3
   per1(i,:)=lead1(i,:)-3.*[0 0 c];
   per2(i,:)=lead2(i,:)+3.*[0 0 c];
end

for n1=1:num1
   for n2=1:num2
      for i=1:(N-4*16)
         if (juncf005(i,1)==1)
            fprintf(fid,'C %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'6 %.16f %.16f %.16f\n',condr(i,:));
         elseif (juncf005(i,1)==2)
            fprintf(fid,'H %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'1 %.16f %.16f %.16f\n',condr(i,:));
         elseif (juncf005(i,1)==3)
            fprintf(fid,'N %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'7 %.16f %.16f %.16f\n',condr(i,:));
         elseif (juncf005(i,1)==4)
            fprintf(fid,'F %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'8 %.16f %.16f %.16f\n',condr(i,:));

         elseif (juncf005(i,1)==5)
            fprintf(fid,'S %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'8 %.16f %.16f %.16f\n',condr(i,:));

         else
            fprintf(fid,'Au %.16f %.16f %.16f \n',condr(i,:)+(n1-1).*x+(n2-1).*y);
            fprintf(fid6,'79 %.16f %.16f %.16f\n',condr(i,:));
         end      end
		for i=1:16*3
         fprintf(fid,'Au %.16f %.16f %.16f \n',lead1(i,:)+(n1-1).*x+(n2-1).*y);
         fprintf(fid6,'79 %.16f %.16f %.16f\n',lead1(i,:));
      end
      for i=1:16*3
         fprintf(fid,'Au %.16f %.16f %.16f \n',lead2(i,:)+(n1-1).*x+(n2-1).*y);
         fprintf(fid6,'79 %.16f %.16f %.16f\n',lead2(i,:));
      end
      for i=1:16*3
         fprintf(fid,'Au %.16f %.16f %.16f \n',per1(i,:)+(n1-1).*x+(n2-1).*y);
      end
      for i=1:16*3
         fprintf(fid,'Au %.16f %.16f %.16f \n',per2(i,:)+(n1-1).*x+(n2-1).*y);
      end
                       
   end %num2
   end%num1
   
   	for i=1:(N-4*16)
         fprintf(fid2,'%.16f %.16f %.16f %d\n',condr(i,:), juncf005(i,1));
      end
      for i=1:16*3
         fprintf(fid2,'%.16f %.16f %.16f 6 #lead1\n',lead1(i,:));
      end
      for i=1:16*3
         fprintf(fid2,'%.16f %.16f %.16f 6 #lead2\n',lead2(i,:));
      end
 		for i=1:16*3
         fprintf(fid2,'%.16f %.16f %.16f 6 #per1\n',per1(i,:));
      end
      for i=1:16*3
         fprintf(fid2,'%.16f %.16f %.16f 6 #per2\n',per2(i,:));
      end
      
 for i=1:16*3
         fprintf(fid3,'%.16f %.16f %.16f 1 #lead1\n',lead1(i,:)-[0 0 6*c]);
 end
 %origin of box is max of conductor.     
 for i=1:16*3
         fprintf(fid4,'%.16f %.16f %.16f 1 #lead2\n',lead2(i,:)-[0 0 max(condr(:,3))]);
 end
 
 lattice = 12*3*c;
 vac=3*c;
fprintf(fid5,'periodic.PRDC-H0\n');
fprintf(fid5,'0.00000000 0.00000000 %.16f # origin (x,y,z) of the box of the middle region\n',vac+3*c);
fprintf(fid5,'%.16f %.16f %.16f # x y z dimensions of the box of the middle region\n',ax,ay,newhtcondr);
fprintf(fid5,'2                      # number of leads\n');
fprintf(fid5,'  0.000000                      # (in eV) shift of the total potential (Vscf) in the 1st lead\n');
fprintf(fid5,'%d %d # starting and ending indices of the atoms of the 1st lead\n',length(condr(:,1))+1,length(condr(:,1))+length(lead1(:,1)));
fprintf(fid5,'0.00000000 0.00000000  %.16f # repeating vector of the atomic positions\n',-3*c);
fprintf(fid5,'%d %d %d # nel nband nk\n',11*length(lead1(:,1)),11*length(lead1(:,1))/2 + 80, 3000);
fprintf(fid5,'0.00000000 0.00000000 0.00000000 # origin (x,y,z) of the box of the lead\n');
fprintf(fid5,'%.16f %.16f %.16f # x y z dimensions of the box of the lead\n',ax,ay,vac+3*c);
fprintf(fid5,'leftlead.LEAD-HS\n');
fprintf(fid5,'leftlead.LEAD-POT\n');
fprintf(fid5,'  0.000000                      # (in eV) shift of the total potential (Vscf) in the 2nd lead\n');
fprintf(fid5,'%d %d # starting and ending indices of the atoms of the 2nd lead\n',length(condr(:,1))+length(lead1(:,1))+1,length(condr(:,1))+length(lead1(:,1))+length(lead2(:,1)));
fprintf(fid5,'0.00000000 0.00000000  %.16f # repeating vector of the atomic positions\n',3*c);
fprintf(fid5,'%d %d %d # nel nband nk\n',11*length(lead1(:,1)),11*length(lead1(:,1))/2 + 80, 3000);
fprintf(fid5,'0.00000000 0.00000000 %.16f # origin (x,y,z) of the box of the lead\n',vac+3*c+newhtcondr);
fprintf(fid5,'%.16f %.16f %.16f # x y z dimensions of the box of the lead\n',ax,ay,lattice-(vac+3*c+newhtcondr));
fprintf(fid5,'rightlead.LEAD-HS\n');
fprintf(fid5,'rightlead.LEAD-POT\n');
fprintf(fid5,'main lattice ht = %.16f',lattice);

fclose(fid);
fclose(fid2);
fclose(fid3);
fclose(fid4);
fclose(fid5);
fclose(fid6);

 
      
